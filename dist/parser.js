"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.parseToAst=J;const V=require("./func/normalizeLiteral"),z=new Set(["SELECT","DISTINCT","TOP","FROM","AS","INNER","LEFT","JOIN","ON","WHERE","GROUP","BY","HAVING","ORDER","ASC","DESC","LIMIT","OFFSET","AND","OR","NOT","IN","BETWEEN","LIKE","CASE","WHEN","THEN","ELSE","END","EXISTS","UPDATE","SET","PUSH","EACH","UNSET","RETURNING","TRUE","FALSE"]);function j(n){const t=[],r=/\s+|(--.*?$)|(!=|<>|>=|<=)|([(),.*=<>+\/\-\[\]\{\}])|'(?:''|[^'])*'|\b(?:[A-Za-z_][A-Za-z0-9_]*|\d+[A-Za-z_][A-Za-z0-9_]*)\b|\d+(?:\.\d+)?/gms;let l;for(;(l=r.exec(n))!==null;){const i=l[0],p=r.lastIndex-i.length,u=r.lastIndex;if(/^\s+$/.test(i)||i.startsWith("--"))continue;if(["!=","<>",">=","<=",">","<","=","(",")",",",".","*","+","/","-","[","]","{","}"].includes(i)){t.push({type:i,value:i,start:p,end:u});continue}if(i.startsWith("'")){t.push({type:"STRING",value:i,start:p,end:u});continue}if(/^[0-9]+(?:\.[0-9]+)?$/.test(i)){t.push({type:"NUMBER",value:i,start:p,end:u});continue}const v=i.toUpperCase();z.has(v)?t.push({type:v,value:i,start:p,end:u}):t.push({type:"IDENT",value:i,start:p,end:u})}return t}let O,R,H;function o(n=0){return R[O+n]}function e(n){const t=R[O++];if(n&&(!t||t.type!==n))throw new Error("Se esperaba "+n+" y lleg\xF3 "+(t?t.type:"EOF"));return t}function s(n){const t=o();return t&&t.type===n?(O++,!0):!1}function J(n){const t=n.trim().replace(/;$/,"");R=j(t),O=0,H=t;const r=o();if(!r)throw new Error("Sentencia vac\xEDa");if(r.type==="SELECT")return X();if(r.type==="UPDATE")return Z();throw new Error("Sentencia no soportada: "+r.value)}function X(){var n,t;e("SELECT");let r=!1;s("DISTINCT")&&(r=!0);let l;if(s("TOP")){const I=e("NUMBER");l=Number(I.value)}const i=$();e("FROM");const p=G(),u=ie();let v;s("WHERE")&&(v=A("WHERE"));let a;s("GROUP")&&(e("BY"),a=re());let E;s("HAVING")&&(E=A("HAVING"));let c;s("ORDER")&&(e("BY"),c=le());let h,f,T;if(s("LIMIT")&&(h=Number(e("NUMBER").value)),s("OFFSET")&&(f=Number(e("NUMBER").value)),s("REORDER")){let I="ASC";if((((n=o())===null||n===void 0?void 0:n.type)==="ASC"||((t=o())===null||t===void 0?void 0:t.type)==="DESC")&&(I=e(o().type).type),!(c!=null&&c.length))throw new Error("REORDER requiere ORDER BY previo");T={direction:I}}l!==void 0&&h===void 0&&(h=l);const N=i.some(I=>{if(I.type==="AliasedExpression"){const w=I.expression;return(w==null?void 0:w.type)==="FunctionCall"&&U.has(w.name)}return!1}),_=i.some(I=>I.type==="ColumnRef"||I.type==="Wildcard");if(N&&_&&!(a!=null&&a.length))throw new Error("Mezcla de columnas y agregados requiere GROUP BY");const m={type:"SelectStatement",columns:i,from:p,joins:u,where:v,having:E,orderBy:c,limit:h,offset:f,distinct:r,groupBy:a,reorderFinal:T},C=[];for(const I of i)if(I.type==="ColumnRef"){const w=I.alias||I.name.split(".").slice(-1)[0];if(C.includes(w))throw new Error("Alias duplicado en SELECT: "+w);C.push(w)}else if(I.type==="AliasedExpression"){const w=I.alias;if(C.includes(w))throw new Error("Alias duplicado en SELECT: "+w);C.push(w)}if(E){let S=function(y){switch(y.type){case"ColumnRef":{const D=y.name;D.includes(".")||I.has(D)||w.has(D)||b.push(D);break}case"BinaryOp":S(y.left),S(y.right);break;case"InExpression":S(y.left),y.values.forEach(S);break;case"BetweenExpression":S(y.value),S(y.lower),S(y.upper);break;case"LikeExpression":S(y.value);break;case"ParenExpression":S(y.expression);break;case"FunctionCall":y.args.forEach(S);break;case"ArithmeticOp":S(y.left),S(y.right);break;case"CaseExpression":y.branches.forEach(D=>{S(D.when),S(D.then)}),y.else&&S(y.else);break}};const I=new Set;for(const y of i)y.type==="AliasedExpression"&&y.expression.type==="FunctionCall"&&I.add(y.alias);const w=new Set((a||[]).map(y=>y.alias||y.name.split(".").slice(-1)[0])),b=[];if(S(E),b.length)throw new Error("HAVING referencia alias o columna no agrupada: "+Array.from(new Set(b)).join(", "))}return m}function Z(){var n;e("UPDATE");const t=e("IDENT").value;let r;if(s("AS"))r=e("IDENT").value;else{const a=o();a&&a.type==="IDENT"&&((n=o(1))===null||n===void 0?void 0:n.type)!=="SET"&&(r=e("IDENT").value)}e("SET");const l=[];for(;;){const a=e("IDENT"),E=x(a.value);let c="set",h,f,T;const N=o();if((N==null?void 0:N.type)==="+")e("+"),e("="),c="inc",h=1,f=d();else if((N==null?void 0:N.type)==="-")e("-"),e("="),c="inc",h=-1,f=d();else if((N==null?void 0:N.type)==="*")e("*"),e("="),c="mul",f=d();else if((N==null?void 0:N.type)==="PUSH")if(e("PUSH"),s("EACH")){if(c="pushEach",e("("),T=[],!s(")")){for(T.push(d());s(",");)T.push(d());e(")")}if(!T.length)throw new Error("PUSH EACH requiere al menos un valor")}else c="push",f=d();else(N==null?void 0:N.type)==="UNSET"?(e("UNSET"),c="unset"):(e("="),f=d());if(l.push({type:"UpdateAssignment",column:E,value:f,values:T,operator:c,sign:h}),!s(","))break}let i;s("WHERE")&&(i=A("WHERE"));let p;s("LIMIT")&&(p=Number(e("NUMBER").value));let u;if(s("RETURNING")){const a=Q();if(!a.length)throw new Error("RETURNING requiere al menos una expresi\xF3n");const E=new Set;for(const c of a){if(c.type==="Wildcard"){if(a.length>1)throw new Error("RETURNING * no puede combinarse con otras columnas");continue}const h=c.type==="ColumnRef"?c.alias||c.name.split(".").slice(-1)[0]:c.alias;if(E.has(h))throw new Error("Alias duplicado en RETURNING: "+h);E.add(h)}u={type:"ReturningClause",items:a}}return{type:"UpdateStatement",target:{type:"FromSource",name:t,alias:r},assignments:l,where:i,limit:p,returning:u}}function $(){const n=[];for(;n.push(W()),!!s(",");){const t=o();if(!t||["FROM","WHERE","GROUP","HAVING","ORDER","LIMIT","OFFSET","REORDER"].includes(t.type))break}return n}function Q(){const n=[];for(;n.push(W()),!(!s(",")||!o()););return n}function q(){const n=[];for(;;){if(s("{")){e("}"),n.push("object");continue}if(s("[")){e("]"),n.push("array");continue}break}return n}function x(n){let t=n;if(s(".")){let i=e("IDENT").value;for(;s(".");)i+="."+e("IDENT").value;t=n+"."+i}const r=q(),l={type:"ColumnRef",name:t};return r.length&&(l.traversal=r),l}const U=new Set(["COUNT","SUM","AVG","MIN","MAX","COUNT_IF"]),ee=["LOWER","UPPER","ABS","COALESCE","NULLIF","LABEL","ID","TO_LOCAL","TO_UTC","SHIFT_HOURS","YEAR","MONTH","DAY","DAY_OF_MONTH","HOUR","MINUTE","SECOND","MILLISECOND","WEEK","ISO_WEEK","ISO_WEEK_YEAR","ISO_DAY_OF_WEEK","START_OF_DAY","END_OF_DAY","NOW","TO_DATE","DATE_ONLY_LOCAL","TIME_ONLY_LOCAL","FORMAT_LOCAL","FORMAT_UTC","SIZE","ROUND","FLOOR","CEIL","CEILING","DATE_TRUNC","DATE_DIFF","DATEDIFF","DATE_ADD","DATE_SUB","DATE_PART"],F=new Set(ee);function L(){var n;if(((n=o())===null||n===void 0?void 0:n.type)!=="SELECT")throw new Error("Se esperaba una subconsulta SELECT");const r=R[O].start;let l=1,i=O;for(;i<R.length;){const v=R[i];if(v.type==="(")l++;else if(v.type===")"&&(l--,l===0))break;i++}if(l!==0)throw new Error("Subconsulta sin cerrar");const p=i,u=H.slice(r,R[p].start).trim();return O=p+1,u}function B(){var n,t;e("CASE");const r=[];for(;((n=o())===null||n===void 0?void 0:n.type)==="WHEN";){e("WHEN");const p=A("WHERE",new Set(["THEN"]));e("THEN");const u=d();r.push({when:p,then:u})}let l;return((t=o())===null||t===void 0?void 0:t.type)==="ELSE"&&(e("ELSE"),l=d()),e("END"),{type:"CaseExpression",branches:r,else:l}}function W(){var n,t,r,l,i,p,u,v;const a=o();if(!a)throw new Error("Token inesperado en lista SELECT");if(a.type==="*")return e("*"),{type:"Wildcard"};if(a.type==="IDENT"&&((n=o(1))===null||n===void 0?void 0:n.type)==="."&&((t=o(2))===null||t===void 0?void 0:t.type)==="*"){const f=e("IDENT").value;return e("."),e("*"),{type:"Wildcard",source:f}}if(a.type==="CASE"){const f=B();let T;return(s("AS")||((r=o())===null||r===void 0?void 0:r.type)==="IDENT")&&(T=e("IDENT").value),{type:"AliasedExpression",expression:f,alias:T||"case_expr"}}if(a.type==="IDENT"&&U.has(a.value.toUpperCase())){const f=e("IDENT").value.toUpperCase();e("(");const T=[];let N=!1,_=!1;if(s("*"))N=!0,e(")");else if(f==="COUNT_IF"){if(((l=o())===null||l===void 0?void 0:l.type)===")")throw new Error("COUNT_IF requiere un argumento");if(T.push(A("WHERE",new Set([")"]))),s(","))throw new Error("COUNT_IF solo admite un argumento");e(")")}else if(((i=o())===null||i===void 0?void 0:i.type)==="DISTINCT"){if(e("DISTINCT"),_=!0,s(")"))throw new Error("DISTINCT requiere una expresi\xF3n");for(T.push(d());s(",");)T.push(d());e(")")}else if(!s(")")){for(T.push(d());s(",");)T.push(d());e(")")}let m;(s("AS")||((p=o())===null||p===void 0?void 0:p.type)==="IDENT")&&(m=e("IDENT").value);const C={type:"FunctionCall",name:f,args:T,wildcard:N,distinct:_};return m?{type:"AliasedExpression",expression:C,alias:m}:{type:"AliasedExpression",expression:C,alias:f.toLowerCase()}}if(a.type==="IDENT"&&F.has(a.value.toUpperCase())){const f=e("IDENT").value.toUpperCase();e("(");const T=[];if(!s(")")){for(T.push(d());s(",");)T.push(d());e(")")}let N;return(s("AS")||((u=o())===null||u===void 0?void 0:u.type)==="IDENT")&&(N=e("IDENT").value),{type:"AliasedExpression",expression:{type:"FunctionCall",name:f,args:T},alias:N||f.toLowerCase()}}const E=d();let c;if((s("AS")||((v=o())===null||v===void 0?void 0:v.type)==="IDENT")&&(c=e("IDENT").value),E.type==="ColumnRef")return c?{...E,alias:c}:E;const h=c||te(E);return{type:"AliasedExpression",expression:E,alias:h}}function te(n){switch(n.type){case"FunctionCall":return(n.name||"expr").toLowerCase();case"ArithmeticOp":return"expr";case"CaseExpression":return"case_expr";default:return"expr"}}function g(){const n=o();if(!n)throw new Error("Expresi\xF3n incompleta");if(n.type==="TRUE")return e("TRUE"),{type:"Literal",value:!0};if(n.type==="FALSE")return e("FALSE"),{type:"Literal",value:!1};if(n.type==="IDENT"){const t=e("IDENT").value;return x(t)}if(n.type==="STRING"){const r=e("STRING").value.slice(1,-1).replace(/''/g,"'");return{type:"Literal",value:(0,V.normalizeLiteralValue)(r)}}if(n.type==="NUMBER")return{type:"Literal",value:Number(e("NUMBER").value)};if(n.type==="["){e("[");const t=[];if(!s("]")){for(t.push(d());s(",");)t.push(d());e("]")}return{type:"ArrayExpression",elements:t}}throw new Error("Expresi\xF3n no soportada")}function d(){return ne()}function ne(){var n,t;let r=M();for(;((n=o())===null||n===void 0?void 0:n.type)==="+"||((t=o())===null||t===void 0?void 0:t.type)==="-";){const l=e(o().type).type,i=M();r={type:"ArithmeticOp",operator:l,left:r,right:i}}return r}function M(){var n,t;let r=k();for(;((n=o())===null||n===void 0?void 0:n.type)==="*"||((t=o())===null||t===void 0?void 0:t.type)==="/";){const l=e(o().type).type,i=k();r={type:"ArithmeticOp",operator:l,left:r,right:i}}return r}function k(){var n,t,r,l;if(((n=o())===null||n===void 0?void 0:n.type)==="("){if(e("("),((t=o())===null||t===void 0?void 0:t.type)==="SELECT")return{type:"ScalarSubquery",subquerySql:L()};const p=d();return e(")"),p}const i=o();if((i==null?void 0:i.type)==="+"||(i==null?void 0:i.type)==="-"){const p=e(o().type).type,u=k();return p==="-"?{type:"ArithmeticOp",operator:"-",left:{type:"Literal",value:0},right:u}:u}if((i==null?void 0:i.type)==="IDENT"&&U.has(i.value.toUpperCase())){const p=e("IDENT").value.toUpperCase();e("(");const u=[];let v=!1,a=!1;if(s("*"))v=!0,e(")");else if(p==="COUNT_IF"){if(((r=o())===null||r===void 0?void 0:r.type)===")")throw new Error("COUNT_IF requiere un argumento");if(u.push(A("WHERE",new Set([")"]))),s(","))throw new Error("COUNT_IF solo admite un argumento");e(")")}else{if(((l=o())===null||l===void 0?void 0:l.type)==="DISTINCT"&&(e("DISTINCT"),a=!0,s(")")))throw new Error("DISTINCT requiere una expresi\xF3n");if(s(")")){if(!v)throw new Error("Funci\xF3n "+p+" requiere argumentos")}else{for(u.push(d());s(",");)u.push(d());e(")")}}return{type:"FunctionCall",name:p,args:u,wildcard:v,distinct:a}}if((i==null?void 0:i.type)==="CASE")return B();if((i==null?void 0:i.type)==="IDENT"&&F.has(i.value.toUpperCase())){const p=e("IDENT").value.toUpperCase();e("(");const u=[];if(!s(")")){for(u.push(d());s(",");)u.push(d());e(")")}return{type:"FunctionCall",name:p,args:u}}return g()}function re(){const n=[];for(;;){const t=e("IDENT").value;if(n.push(x(t)),!s(","))break;const r=o();if(!r||["HAVING","ORDER","LIMIT","OFFSET","REORDER"].includes(r.type))break}return n}function G(){var n;const t=e("IDENT").value;let r;return(s("AS")||((n=o())===null||n===void 0?void 0:n.type)==="IDENT")&&(r=e("IDENT").value),{type:"FromSource",name:t,alias:r}}function ie(){const n=[];for(;;){let t;if(s("INNER"))e("JOIN"),t="INNER";else if(s("LEFT"))e("JOIN"),t="LEFT";else if(s("JOIN"))t="INNER";else break;const r=G();e("ON");const l=se();n.push({type:"Join",joinType:t,source:r,on:l})}return n}function se(){const n=P(),t=e("="),r=P();return{type:"BinaryOp",operator:t.value,left:n,right:r}}function P(){const n=e("IDENT").value;e(".");let t=e("IDENT").value;for(;s(".");)t+="."+e("IDENT").value;const r=q(),l={type:"ColumnRef",name:n+"."+t};return r.length&&(l.traversal=r),l}function A(n,t){return oe(n,t)}function oe(n,t){let r=Y(n,t);for(;o()&&!(t!=null&&t.has(o().type))&&o().type==="OR";){e("OR");const l=Y(n,t);r={type:"BinaryOp",operator:"OR",left:r,right:l}}return r}function Y(n,t){let r=K(n,t);for(;o()&&!(t!=null&&t.has(o().type))&&o().type==="AND";){e("AND");const l=K(n,t);r={type:"BinaryOp",operator:"AND",left:r,right:l}}return r}function K(n,t){var r,l,i,p,u;if(s("(")){const f=A(n,t);return e(")"),{type:"ParenExpression",expression:f}}if(((r=o())===null||r===void 0?void 0:r.type)==="NOT"&&((l=o(1))===null||l===void 0?void 0:l.type)==="EXISTS")return e("NOT"),e("EXISTS"),e("("),{type:"ExistsExpression",subquerySql:L(),not:!0};if(((i=o())===null||i===void 0?void 0:i.type)==="EXISTS")return e("EXISTS"),e("("),{type:"ExistsExpression",subquerySql:L()};const v=d();let a=!1;s("NOT")&&(a=!0);const E=o();if(E&&(t!=null&&t.has(E.type))){if(a)throw new Error("NOT usado sin IN/BETWEEN/LIKE");return v}if((E==null?void 0:E.type)==="IN"){if(e("IN"),e("("),((p=o())===null||p===void 0?void 0:p.type)==="SELECT"){const T=L();return{type:"InExpression",left:v,values:[],not:a,subquerySql:T}}const f=[];if(!s(")")){do f.push(g());while(s(","));e(")")}return{type:"InExpression",left:v,values:f,not:a}}if((E==null?void 0:E.type)==="BETWEEN"){e("BETWEEN");const f=d();e("AND");const T=d();return{type:"BetweenExpression",value:v,lower:f,upper:T,not:a}}if((E==null?void 0:E.type)==="LIKE"){e("LIKE");const f=g();return{type:"LikeExpression",value:v,pattern:f,not:a}}if(a)throw new Error("NOT usado sin IN/BETWEEN/LIKE");const c=e(((u=o())===null||u===void 0?void 0:u.type)||"="),h=d();return{type:"BinaryOp",operator:c.value.toUpperCase(),left:v,right:h}}function le(){var n,t;const r=[];for(;;){const l=o();let i;if((l==null?void 0:l.type)==="IDENT")if(U.has(l.value.toUpperCase())||F.has(l.value.toUpperCase())){const a=e("IDENT").value.toUpperCase();e("(");const E=[];let c=!1,h=!1;if(a==="COUNT"&&s("*"))c=!0,e(")");else if(a==="COUNT_IF"){if(((n=o())===null||n===void 0?void 0:n.type)===")")throw new Error("COUNT_IF requiere un argumento");if(E.push(A("WHERE",new Set([")"]))),s(","))throw new Error("COUNT_IF solo admite un argumento");e(")")}else{if(((t=o())===null||t===void 0?void 0:t.type)==="DISTINCT"&&(e("DISTINCT"),h=!0,s(")")))throw new Error("DISTINCT requiere una expresi\xF3n");if(s(")")){if(!c)throw new Error("Funci\xF3n "+a+" requiere argumentos")}else{for(E.push(d());s(",");)E.push(d());e(")")}}i={type:"FunctionCall",name:a,args:E,wildcard:c,distinct:h}}else{const a=e("IDENT").value;i=x(a)}else i=d();let p="ASC";const u=o();if(u&&(u.type==="ASC"||u.type==="DESC")&&(p=e(u.type).type),r.push({type:"OrderByItem",expression:i,direction:p}),!s(","))break;const v=o();if(!v||["LIMIT","OFFSET","REORDER"].includes(v.type))break}return r}
