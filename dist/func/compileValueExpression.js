"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compileValueExpression=$;const v=require("./compileTraversalExpression"),A=require("./build/buildSizeExpression"),_=require("./mapColumnToPath"),D=require("./components/compilePredicateForCase"),T=require("./normalizeLiteral");function $(c,d){var m,g,p;if(!c)return null;switch(c.type){case"ColumnRef":{const r=c;if(r.paramRef){let a="$$"+r.paramRef;return!((m=r.traversal)===null||m===void 0)&&m.length&&(a=(0,v.compileTraversalExpression)(a,r.traversal)),a}const l=(0,_.mapColumnToPath)(r,d,!0);if(!l)return null;let t;if(/\.label$/.test(l)){const a=l.replace(/\.label$/,"");t={$ifNull:["$"+l,"$"+a]}}else if(/\.value$/.test(l)){const a=l.replace(/\.value$/,"");t={$ifNull:["$"+l,"$"+a]}}else t="$"+l;return!((g=r.traversal)===null||g===void 0)&&g.length?(0,v.compileTraversalExpression)(t,r.traversal):t}case"Literal":return(0,T.literalNodeValue)(c);case"ArithmeticOp":{const r=c,l=$(r.left,d),t=$(r.right,d);switch(r.operator){case"+":return{$add:[l,t]};case"-":return{$subtract:[l,t]};case"*":return{$multiply:[l,t]};case"/":return{$cond:[{$eq:[t,0]},null,{$divide:[l,t]}]};default:return null}}case"FunctionCall":{const r=c,l=r.name.toUpperCase(),t=e=>r.args[e]!=null?$(r.args[e],d):void 0,a=e=>({$let:{vars:{val:e},in:{$convert:{input:{$cond:[{$ne:[{$type:"$$val"},"string"]},"$$val",{$let:{vars:{str:"$$val",lastCharLower:{$toLower:{$cond:[{$gt:[{$strLenCP:"$$val"},0]},{$substrCP:["$$val",{$subtract:[{$strLenCP:"$$val"},1]},1]},""]}},hasOffset:{$regexMatch:{input:"$$val",regex:"[+\\-]\\d{2}:?\\d{2}$"}},hasTimePart:{$gt:[{$indexOfCP:["$$val","T"]},-1]}},in:{$cond:[{$or:["$$hasOffset",{$eq:["$$lastCharLower","z"]}]},"$$str",{$cond:["$$hasTimePart",{$concat:["$$str","Z"]},{$concat:["$$str","T00:00:00Z"]}]}]}}}]},to:"date",onError:null,onNull:null}}}}),i=(e,n)=>n===void 0?e:{date:e,timezone:n},h=e=>typeof e=="string"?e.toLowerCase():e;switch(l){case"LOWER":return{$toLower:t(0)};case"UPPER":return{$toUpper:t(0)};case"ABS":return{$abs:t(0)};case"COALESCE":return r.args.length?r.args.length===1?t(0):{$ifNull:[t(0),t(1)]}:null;case"NULLIF":{const e=t(0),n=t(1);return{$cond:[{$eq:[e,n]},null,e]}}case"NOW":return"$$NOW";case"ROUND":{const e=t(0);if(e===void 0)return null;const n=r.args.length>=2?t(1):0;return{$let:{vars:{val:e},in:{$cond:[{$eq:["$$val",null]},null,{$round:["$$val",n!=null?n:0]}]}}}}case"FLOOR":{const e=t(0);return e===void 0?null:{$let:{vars:{val:e},in:{$cond:[{$eq:["$$val",null]},null,{$floor:"$$val"}]}}}}case"CEIL":case"CEILING":{const e=t(0);return e===void 0?null:{$let:{vars:{val:e},in:{$cond:[{$eq:["$$val",null]},null,{$ceil:"$$val"}]}}}}case"TO_DATE":return a(t(0));case"DATE_ONLY_LOCAL":{const e=a(t(0)),n=r.args.length>=2?t(1):-5;return{$cond:[{$eq:[e,null]},null,{$dateAdd:{startDate:{$dateTrunc:{date:{$dateAdd:{startDate:e,unit:"hour",amount:n}},unit:"day"}},unit:"hour",amount:{$multiply:[-1,n]}}}]}}case"TIME_ONLY_LOCAL":{const e=a(t(0)),n=r.args.length>=2?t(1):-5;return{$cond:[{$eq:[e,null]},null,{$dateToString:{date:{$dateAdd:{startDate:e,unit:"hour",amount:n}},format:"%H:%M:%S",timezone:"UTC"}}]}}case"FORMAT_LOCAL":{const e=a(t(0)),n=t(1),u=r.args.length>=3?t(2):-5;return{$cond:[{$eq:[e,null]},null,{$dateToString:{date:{$dateAdd:{startDate:e,unit:"hour",amount:u}},format:n,timezone:"UTC"}}]}}case"FORMAT_UTC":{const e=a(t(0)),n=t(1);return{$cond:[{$eq:[e,null]},null,{$dateToString:{date:e,format:n,timezone:"UTC"}}]}}case"SHIFT_HOURS":{const e=a(t(0)),n=t(1);return{$cond:[{$eq:[e,null]},null,{$dateAdd:{startDate:e,unit:"hour",amount:n}}]}}case"TO_LOCAL":{const e=a(t(0)),n=r.args.length>=2?t(1):-5;return{$cond:[{$eq:[e,null]},null,{$dateAdd:{startDate:e,unit:"hour",amount:n}}]}}case"TO_UTC":{const e=a(t(0)),n=r.args.length>=2?t(1):-5;return{$cond:[{$eq:[e,null]},null,{$dateAdd:{startDate:e,unit:"hour",amount:{$multiply:[-1,n]}}}]}}case"START_OF_DAY":{const e=a(t(0)),n=r.args.length>=2?t(1):0;return{$cond:[{$eq:[e,null]},null,{$dateAdd:{startDate:{$dateTrunc:{date:{$dateAdd:{startDate:e,unit:"hour",amount:n}},unit:"day"}},unit:"hour",amount:{$multiply:[-1,n]}}}]}}case"END_OF_DAY":{const e=a(t(0)),n=r.args.length>=2?t(1):0;return{$cond:[{$eq:[e,null]},null,{$dateAdd:{startDate:{$dateAdd:{startDate:{$dateAdd:{startDate:{$dateTrunc:{date:{$dateAdd:{startDate:e,unit:"hour",amount:n}},unit:"day"}},unit:"day",amount:1}},unit:"millisecond",amount:-1}},unit:"hour",amount:{$multiply:[-1,n]}}}]}}case"YEAR":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$year:i(e,n)}}case"MONTH":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$month:i(e,n)}}case"DAY":case"DAY_OF_MONTH":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$dayOfMonth:i(e,n)}}case"HOUR":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$hour:i(e,n)}}case"MINUTE":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$minute:i(e,n)}}case"SECOND":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$second:i(e,n)}}case"MILLISECOND":return{$millisecond:a(t(0))};case"WEEK":case"ISO_WEEK":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$isoWeek:i(e,n)}}case"ISO_WEEK_YEAR":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$isoWeekYear:i(e,n)}}case"ISO_DAY_OF_WEEK":{const e=a(t(0)),n=r.args.length>=2?t(1):void 0;return{$isoDayOfWeek:i(e,n)}}case"DATE_TRUNC":{if(r.args.length<2)return null;const e=t(0);if(e===void 0)return null;const n=a(t(1)),u=r.args.length>=3?t(2):void 0,o=r.args.length>=4?t(3):void 0,s={date:n,unit:h(e)};return u!==void 0&&(s.timezone=u),o!==void 0&&(s.startOfWeek=o),{$dateTrunc:s}}case"DATE_DIFF":case"DATEDIFF":{if(r.args.length<3)return null;const e=t(0);if(e===void 0)return null;const n=a(t(1)),u=a(t(2)),o=r.args.length>=4?t(3):void 0,s={startDate:n,endDate:u,unit:h(e)};return o!==void 0&&(s.timezone=o),{$dateDiff:s}}case"DATE_ADD":case"DATE_SUB":{if(r.args.length<3)return null;const e=a(t(0)),n=t(1),u=t(2);if(u===void 0)return null;const o=r.args.length>=4?t(3):void 0;if(n===void 0)return null;const f={startDate:e,amount:l==="DATE_SUB"?{$multiply:[-1,n]}:n,unit:h(u)};return o!==void 0&&(f.timezone=o),{$dateAdd:f}}case"DATE_PART":{if(r.args.length<2)return null;const e=t(0);if(typeof e!="string")return null;const n=e.toLowerCase(),u=a(t(1)),o=r.args.length>=3?t(2):void 0,s=i(u,o);switch(n){case"year":return{$year:s};case"month":return{$month:s};case"day":case"day_of_month":case"dom":return{$dayOfMonth:s};case"day_of_year":case"doy":return{$dayOfYear:s};case"hour":return{$hour:s};case"minute":return{$minute:s};case"second":return{$second:s};case"millisecond":case"ms":return{$millisecond:u};case"week":return{$isoWeek:s};case"iso_week":return{$isoWeek:s};case"iso_week_year":case"iso_year":return{$isoWeekYear:s};case"iso_day_of_week":case"weekday":return{$isoDayOfWeek:s};case"quarter":return{$ceil:{$divide:[{$month:s},3]}};case"epoch":return{$cond:[{$eq:[u,null]},null,{$divide:[{$subtract:[u,new Date("1970-01-01T00:00:00Z")]},1e3]}]};default:return null}}case"LABEL":{const e=t(0);if(typeof e=="string"&&e.startsWith("$")){const n=e.substring(1)+".label";if(r.args[0].type==="ColumnRef"){const o=r.args[0].name.split(".");if(o.length>1){const s=o[0],f=o.slice(1).join("."),E=s+"."+f+".label";return{$ifNull:["$"+n,"$"+E]}}}return"$"+n}return null}case"ID":{const e=t(0);if(typeof e=="string"&&e.startsWith("$")){const n=e.substring(1)+".value";if(r.args[0].type==="ColumnRef"){const o=r.args[0].name.split(".");if(o.length>1){const s=o[0],f=o.slice(1).join("."),E=s+"."+f+".value";return{$ifNull:["$"+n,"$"+E]}}}return"$"+n}return null}case"SIZE":{const e=t(0);return e==null?null:(0,A.buildSizeExpression)(e)}default:return null}}case"CaseExpression":{const r=c;let l=r.else?$(r.else,d):null;for(let t=r.branches.length-1;t>=0;t--){const a=r.branches[t],i=(0,D.compilePredicateForCase)(a.when,d),h=$(a.then,d);l={$cond:[i,h,l]}}return l}case"ArrayExpression":{const r=c;if(!r.elements.length)return[];const l=r.elements.map(t=>$(t,d));return l.some(t=>t===void 0)?null:l}case"ScalarSubquery":{const r=c;return r.resolved?(p=r.resolvedValue)!==null&&p!==void 0?p:null:r.lookupAlias&&r.valueField?{$let:{vars:{values:{$ifNull:[`$${r.lookupAlias}.${r.valueField}`,[]]}},in:{$cond:[{$gt:[{$size:"$$values"},0]},{$arrayElemAt:["$$values",0]},null]}}}:null}default:return null}}
