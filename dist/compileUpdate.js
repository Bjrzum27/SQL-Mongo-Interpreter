"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compileUpdate=E,exports.createUpdateContext=b;const g=require("./func/build/buildMatch"),y=require("./func/mapColumnToPath"),d=require("./func/compileValueExpression"),w=require("./compiler");function E(s,p={}){var u;const t=b(s);let c=s.where?(0,g.buildMatch)(s.where,t)||{}:{};c=k(c);const a=(u=p.scalarLookups)!==null&&u!==void 0?u:[],r={},l=[];a.length&&l.push(...a.map(e=>e.alias));for(const e of s.assignments){const o=(0,y.mapColumnToPath)(e.column,t,!0)||e.column.name;switch(e.operator){case"set":{const n=(0,d.compileValueExpression)(e.value,t);if(n==null)throw new Error(`No se pudo compilar la expresi\xF3n de asignaci\xF3n para ${e.column.name}`);r[o]=n;break}case"inc":{const n=(0,d.compileValueExpression)(e.value,t);if(n==null)throw new Error(`No se pudo compilar la expresi\xF3n de incremento para ${e.column.name}`);const i={$ifNull:[`$${o}`,0]};e.sign===-1?r[o]={$subtract:[i,n]}:r[o]={$add:[i,n]};break}case"mul":{const n=(0,d.compileValueExpression)(e.value,t);if(n==null)throw new Error(`No se pudo compilar la expresi\xF3n de multiplicaci\xF3n para ${e.column.name}`);const i={$ifNull:[`$${o}`,1]};r[o]={$multiply:[i,n]};break}case"push":{const n=(0,d.compileValueExpression)(e.value,t);if(n==null)throw new Error(`No se pudo compilar la expresi\xF3n de PUSH para ${e.column.name}`);const i={$ifNull:[`$${o}`,[]]};r[o]={$concatArrays:[i,[n]]};break}case"pushEach":{const i=(e.values||[]).map(f=>(0,d.compileValueExpression)(f,t));if(!i.length||i.some(f=>f==null))throw new Error(`No se pudo compilar la expresi\xF3n de PUSH EACH para ${e.column.name}`);const h={$ifNull:[`$${o}`,[]]};r[o]={$concatArrays:[h,i]};break}case"unset":{l.push(o);break}default:throw new Error(`Operador de UPDATE no soportado: ${e.operator}`)}}const m=[],$=[...l];if(a.length)for(const e of a){const o={};for(const[i,h]of Object.entries(e.variables))o[i]=h;const n=(0,w.compileToAggregation)(e.subquery,{limit:1});m.push({$lookup:{from:e.subquery.from.name,let:o,pipeline:n,as:e.alias}})}if(Object.keys(r).length&&m.push({$set:r}),l.length&&m.push({$unset:l.length===1?l[0]:l}),!m.length)throw new Error("La sentencia UPDATE requiere al menos una asignaci\xF3n");return{filter:c,updatePipeline:m,limitOne:s.limit===1,setStage:r,unsetFields:$}}function b(s){return{type:"SelectStatement",columns:[],from:s.target,joins:[],where:s.where,having:void 0,orderBy:void 0,limit:void 0,offset:void 0,distinct:!1,groupBy:void 0,reorderFinal:void 0,correlatedLookups:void 0}}function k(s){if(!s||typeof s!="object")return{};const p=t=>{if(Array.isArray(t))return t.map(p).filter(a=>a&&Object.keys(a).length>0);if(t&&typeof t=="object"){const c=Object.entries(t).map(([a,r])=>[a,p(r)]).filter(([a,r])=>Array.isArray(r)?r.length>0:r&&typeof r=="object"?Object.keys(r).length>0:r!==void 0);return Object.fromEntries(c)}return t},u=p(s);return Object.keys(u).length?u:{}}
